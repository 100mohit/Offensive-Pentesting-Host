# SMB (Server Message Block): Port Number -- 139,445

SMB SMB (Server Message Block) is one of the most important port and this protocol is designed to share files. In SMB, authentication is required to access resources or files. Basically SMB runs on default port number 139 or 445. Strong password should be used by the admin on their important resources so that it cannot be easily guessable. 
SMB has been used primarily to connect Windows computers, although most other systems -- such as Linux and macOS -- also include client components for connecting to SMB resources.

### SMB Versions
```
    CIFS: The old version of SMB, which was included in Microsoft Windows NT 4.0 in 1996.
    SMB 1.0 / SMB1: The version used in Windows 2000, Windows XP, Windows Server 2003 and Windows Server 2003 R2.
    SMB 2.0 / SMB2: This version used in Windows Vista and Windows Server 2008.
    SMB 2.1 / SMB2.1: This version used in Windows 7 and Windows Server 2008 R2.
    SMB 3.0 / SMB3: This version used in Windows 8 and Windows Server 2012.
    SMB 3.02 / SMB3: This version used in Windows 8.1 and Windows Server 2012 R2.
    SMB 3.1: This version used in Windows Server 2016 and Windows 10.
```
### Enumeration Tools:

SMB enumeration provide important information about our target.

#### Nmap

```
root@kali:~# ls /usr/share/nmap/scripts/ | grep smb

		smb2-capabilities.nse
		smb2-security-mode.nse
		smb2-time.nse
		smb2-vuln-uptime.nse
		smb-brute.nse
		smb-double-pulsar-backdoor.nse
		smb-enum-domains.nse
		smb-enum-groups.nse
		smb-enum-processes.nse
		smb-enum-services.nse
		smb-enum-sessions.nse
		smb-enum-shares.nse
		smb-enum-users.nse
		smb-flood.nse
		smb-ls.nse
		smb-mbenum.nse
		smb-os-discovery.nse
		smb-print-text.nse
		smb-protocols.nse
		smb-psexec.nse
		smb-security-mode.nse
		smb-server-stats.nse
		smb-system-info.nse
		smb-vuln-conficker.nse
		smb-vuln-cve2009-3103.nse
		smb-vuln-cve-2017-7494.nse
		smb-vuln-ms06-025.nse
		smb-vuln-ms07-029.nse
		smb-vuln-ms08-067.nse
		smb-vuln-ms10-054.nse
		smb-vuln-ms10-061.nse
		smb-vuln-ms17-010.nse
		smb-vuln-regsvc-dos.nse
```

#### Command to find open SMB shares through nmap
```
 nmap -v --script smb-enum-shares --script-args smbuser=admin,smbpass=admin -p445 192.168.1.0/24
```

### Hostname
 Tools to enumerate hostname
 
```
   # nmblookup -A ip
   # nbtstat -A ip
   # nbtscan ip
```
#### SMB Users
```
nmap -sU -sS --script=smb-enum-users -p U:137,T:139 192.168.1.0/24
```
### Enum4linux
Enumerates Hostname, SMB shares Usernames, passwords.
```
root@kali:~#enum4linux -S 10.10.0.50

		Starting enum4linux v0.8.9 ( http://labs.portcullis.co.uk/application/enum4linux/ )

		 ==========================
		|    Target Information    |
		 ==========================
		Target ........... 10.10.0.50
		RID Range ........ 500-550,1000-1050
		Username ......... ''
		Password ......... ''
		Known Usernames .. administrator, guest, krbtgt, domain admins, root, bin, none

		 ==================================================
		|    Enumerating Workgroup/Domain on 10.10.0.50    |
		 ==================================================
		[+] Got domain/workgroup name: WORKGROUP

		 ===================================
		|    Session Check on 10.10.0.50    |
		 ===================================
		[+] Server 10.10.0.50 allows sessions using username '', password ''

		 =========================================
		|    Getting domain SID for 10.10.0.50    |
		 =========================================
		Domain Name: WORKGROUP
		Domain Sid: (NULL SID)
		[+] Can't determine if host is part of domain or part of a workgroup

		 =======================================
		|    Share Enumeration on 10.10.0.50    |
		 =======================================

		    Sharename       Type      Comment
		    ---------       ----      -------
		    print$          Disk      Printer Drivers
		    tmp             Disk      oh noes!
		    opt             Disk
		    IPC$            IPC       IPC Service (metasploitable server (Samba 3.0.20-Debian))
		    ADMIN$          IPC       IPC Service (metasploitable server (Samba 3.0.20-Debian))
		Reconnecting with SMB1 for workgroup listing.

		    Server               Comment
		    ---------            -------

		    Workgroup            Master
		    ---------            -------
		    WORKGROUP            METASPLOITABLE

		[+] Attempting to map shares on 10.10.0.50
		//10.10.0.50/print$ Mapping: DENIED, Listing: N/A
		//10.10.0.50/tmp    Mapping: OK, Listing: OK
		//10.10.0.50/opt    Mapping: DENIED, Listing: N/A
		//10.10.0.50/IPC$   [E] Can't understand response:
		NT_STATUS_NETWORK_ACCESS_DENIED listing \*
		//10.10.0.50/ADMIN$ Mapping: DENIED, Listing: N/A
```
Flag -p tell us whether we have access or not to a particular share.
```
root@kali:~# enum4linux -P 10.10.0.50

		Starting enum4linux v0.8.9 ( http://labs.portcullis.co.uk/application/enum4linux/ )

		 ==========================
		|    Target Information    |
		 ==========================
		Target ........... 10.10.0.50
		RID Range ........ 500-550,1000-1050
		Username ......... ''
		Password ......... ''
		Known Usernames .. administrator, guest, krbtgt, domain admins, root, bin, none

		 ==================================================
		|    Enumerating Workgroup/Domain on 10.10.0.50    |
		 ==================================================
		[+] Got domain/workgroup name: WORKGROUP

		 ===================================
		|    Session Check on 10.10.0.50    |
		 ===================================
		[+] Server 10.10.0.50 allows sessions using username '', password ''

		 =========================================
		|    Getting domain SID for 10.10.0.50    |
		 =========================================
		Domain Name: WORKGROUP
		Domain Sid: (NULL SID)
		[+] Can't determine if host is part of domain or part of a workgroup

		 ==================================================
		|    Password Policy Information for 10.10.0.50    |
		 ==================================================

		[+] Attaching to 10.10.0.50 using a NULL share

		[+] Trying protocol 445/SMB...

		[+] Found domain(s):

		    [+] METASPLOITABLE
		    [+] Builtin

		[+] Password Info for Domain: METASPLOITABLE

		    [+] Minimum password length: 5
		    [+] Password history length: None
		    [+] Maximum password age: Not Set
		    [+] Password Complexity Flags: 000000

		        [+] Domain Refuse Password Change: 0
		        [+] Domain Password Store Cleartext: 0
		        [+] Domain Password Lockout Admins: 0
		        [+] Domain Password No Clear Change: 0
		        [+] Domain Password No Anon Change: 0
		        [+] Domain Password Complex: 0

		    [+] Minimum password age: None
		    [+] Reset Account Lockout Counter: 30 minutes
		    [+] Locked Account Duration: 30 minutes
		    [+] Account Lockout Threshold: None
		    [+] Forced Log off Time: Not Set

		[+] Retieved partial password policy with rpcclient:

		Password Complexity: Disabled
		Minimum Password Length: 0
```
Flag -o to check the versions.
```
root@kali:~# enum4linux -o 10.10.0.50

		Starting enum4linux v0.8.9 ( http://labs.portcullis.co.uk/application/enum4linux/ )

		 ==========================
		|    Target Information    |
		 ==========================
		Target ........... 10.10.0.50
		RID Range ........ 500-550,1000-1050
		Username ......... ''
		Password ......... ''
		Known Usernames .. administrator, guest, krbtgt, domain admins, root, bin, none

		 ==================================================
		|    Enumerating Workgroup/Domain on 10.10.0.50    |
		 ==================================================
		[+] Got domain/workgroup name: WORKGROUP

		 ===================================
		|    Session Check on 10.10.0.50    |
		 ===================================
		[+] Server 10.10.0.50 allows sessions using username '', password ''

		 =========================================
		|    Getting domain SID for 10.10.0.50    |
		 =========================================
		Domain Name: WORKGROUP
		Domain Sid: (NULL SID)
		[+] Can't determine if host is part of domain or part of a workgroup

		 ====================================
		|    OS information on 10.10.0.50    |
		 ====================================
		Use of uninitialized value $os_info in concatenation (.) or string at ./enum4linux.pl line 464.
		[+] Got OS info for 10.10.0.50 from smbclient:
		[+] Got OS info for 10.10.0.50 from srvinfo:
		    METASPLOITABLE Wk Sv PrQ Unx NT SNT metasploitable server (Samba 3.0.20-Debian)
		    platform_id     :   500
		    os version      :   4.9
		    server type     :   0x9a03
```
We can quickly get all the SMB information we need in one scan — use the -a flag to run all simple enumeration.
```
root@kali:~# enum4linux -a 10.10.0.50

		Starting enum4linux v0.8.9 ( http://labs.portcullis.co.uk/application/enum4linux/ ) 

		 ==========================
		|    Target Information    |
		 ==========================
		Target ........... 10.10.0.50
		RID Range ........ 500-550,1000-1050
		Username ......... ''
		Password ......... ''
		Known Usernames .. administrator, guest, krbtgt, domain admins, root, bin, none

		 ==================================================
		|    Enumerating Workgroup/Domain on 10.10.0.50    |
		 ==================================================
		[+] Got domain/workgroup name: WORKGROUP

		 ==========================================
		|    Nbtstat Information for 10.10.0.50    |
		 ==========================================
		Looking up status of 10.10.0.50
		    METASPLOITABLE  <00> -         B <ACTIVE>  Workstation Service
		    METASPLOITABLE  <03> -         B <ACTIVE>  Messenger Service
		    METASPLOITABLE  <20> -         B <ACTIVE>  File Server Service
		    ..__MSBROWSE__. <01> - <GROUP> B <ACTIVE>  Master Browser
		    WORKGROUP       <00> - <GROUP> B <ACTIVE>  Domain/Workgroup Name
		    WORKGROUP       <1d> -         B <ACTIVE>  Master Browser
		    WORKGROUP       <1e> - <GROUP> B <ACTIVE>  Browser Service Elections

		    MAC Address = 00-00-00-00-00-00

		 ===================================
		|    Session Check on 10.10.0.50    |
		 ===================================
		[+] Server 10.10.0.50 allows sessions using username '', password ''

		...

		 ============================
		|    Groups on 10.10.0.50    |
		 ============================

		[+] Getting builtin groups:

		[+] Getting builtin group memberships:

		[+] Getting local groups:

		[+] Getting local group memberships:

		[+] Getting domain groups:

		[+] Getting domain group memberships:

		 =====================================================================
		|    Users on 10.10.0.50 via RID cycling (RIDS: 500-550,1000-1050)    |
		 =====================================================================
		[I] Found new SID: S-1-5-21-1042354039-2475377354-766472396
		[+] Enumerating users using SID S-1-5-21-1042354039-2475377354-766472396 and logon username '', password ''
		S-1-5-21-1042354039-2475377354-766472396-500 METASPLOITABLE\Administrator (Local User)
		S-1-5-21-1042354039-2475377354-766472396-501 METASPLOITABLE\nobody (Lo
			........................
```
### SMB client:
An SMB client is the device that accesses resources on an SMB server. For example, within a corporate network, the user PCs that access a shared drive are SMB clients.

#### smbclient help
```
root@kali:~# smbclient -h

		Usage: smbclient [-?EgqBVNkPeC] [-?|--help] [--usage]
		[-R|--name-resolve=NAME-RESOLVE-ORDER] [-M|--message=HOST]
		[-I|--ip-address=IP] [-E|--stderr] [-L|--list=HOST]
		[-m|--max-protocol=LEVEL] [-T|--tar=<c|x>IXFvgbNan]
		[-D|--directory=DIR] [-c|--command=STRING] [-b|--send-buffer=BYTES]
		[-t|--timeout=SECONDS] [-p|--port=PORT] [-g|--grepable] [-q|--quiet]
		[-B|--browse] [-d|--debuglevel=DEBUGLEVEL]
		[-s|--configfile=CONFIGFILE] [-l|--log-basename=LOGFILEBASE]
		[-V|--version] [--option=name=value]
		[-O|--socket-options=SOCKETOPTIONS] [-n|--netbiosname=NETBIOSNAME]
		[-W|--workgroup=WORKGROUP] [-i|--scope=SCOPE] [-U|--user=USERNAME]
		[-N|--no-pass] [-k|--kerberos] [-A|--authentication-file=FILE]
		[-S|--signing=on|off|required] [-P|--machine-pass] [-e|--encrypt]
		[-C|--use-ccache] [--pw-nt-hash] service <password>
```

We can get a list of shares using -L flag without knowing username and password
```
root@kali:~# smbclient -L //server -N
root@kali:~# smbclient //server/public -N
```
Manual configuration
```
root@kali:~# smbclient -L //server -U user
```
### SMB Share:
An SMB share, also known as an SMB file share, is simply a shared resource on an SMB server. Often, an SMB share is a directory, but it can be any shared resource. For example, network printers are often shared using SMB.
```
root@kali:~# smbclient //server/share -U user
```
After connecting you can see
```
root@kali:~# smb: \>
```
### SMBMap
This tools help in finding samba share drives across an entire domain.

```
root@kali:~# smbmap -h

		usage: smbmap [-h] (-H HOST | --host-file FILE) [-u USERNAME] [-p PASSWORD]
		[-s SHARE] [-d DOMAIN] [-P PORT] [-v] [--admin] [-x COMMAND]
		[--mode CMDMODE] [-L | -R [PATH] | -r [PATH]] [-A PATTERN | -g]
		[--dir-only] [--no-write-check] [-q] [--depth DEPTH]
		[--exclude SHARE [SHARE ...]] [-F PATTERN] [--search-path PATH]
		[--search-timeout TIMEOUT] [--download PATH] [--upload SRC DST]
		[--delete PATH TO FILE] [--skip]

		SMBMap - Samba Share Enumerator | Shawn Evans - ShawnDEvans@gmail.com

		optional arguments:
		-h, --help show this help message and exit

		Main arguments:
		-H HOST IP of host
		--host-file FILE File containing a list of hosts
		-u USERNAME Username, if omitted null session assumed
		-p PASSWORD Password or NTLM hash
		-s SHARE Specify a share (default C$), ex 'C$'
		-d DOMAIN Domain name (default WORKGROUP)
		-P PORT SMB port (default 445)
		-v Return the OS version of the remote host
		--admin Just report if the user is an admin

		Command Execution:
		Options for executing commands on the specified host

		-x COMMAND Execute a command ex. 'ipconfig /all'
		--mode CMDMODE Set the execution method, wmi or psexec, default wmi

		Shard drive Search:
		Options for searching/enumerating the share of the specified host(s)

		-L List all drives on the specified host
		-R [PATH] Recursively list dirs, and files (no share\path lists
		ALL shares), ex. 'C$\Finance'
		-r [PATH] List contents of directory, default is to list root of
		all shares, ex. -r 'C$\Documents and
		Settings\Administrator\Documents'
		-A PATTERN Define a file name pattern (regex) that auto downloads
		a file on a match (requires -R or -r), not case
		sensitive, ex '(web|global).(asax|config)'
		-g Make the output grep friendly, used with -r or -R
		(otherwise it outputs nothing)
		--dir-only List only directories, ommit files.
		--no-write-check Skip check to see if drive grants WRITE access.
		-q Quiet verbose output. Only shows shares you have READ
		or WRITE on, and suppresses file listing when
		performing a search (-A).
		--depth DEPTH Traverse a directory tree to a specific depth. Default
		is 5.
		--exclude SHARE [SHARE ...]
		Exclude share(s) from searching and listing, ex.
		--exclude ADMIN$ C$'

		File Content Search:
		Options for searching the content of files (must run as root)

		-F PATTERN File content search, -F '[Pp]assword' (requires admin
		access to execute commands, and PowerShell on victim
		host)
		--search-path PATH Specify drive/path to search (used with -F, default
		C:\Users), ex 'D:\HR\'
		--search-timeout TIMEOUT
		Specify a timeout (in seconds) before the file search
		job gets killed. Default is 300 seconds.

		Filesystem interaction:
		Options for interacting with the specified host's filesystem

		--download PATH Download a file from the remote system,
		ex.'C$\temp\passwords.txt'
		--upload SRC DST Upload a file to the remote system ex.
		'/tmp/payload.exe C$\temp\payload.exe'
		--delete PATH TO FILE
		Delete a remote file, ex. 'C$\temp\msf.exe'
		--skip Skip delete file confirmation prompt

Examples:

$ smbmap -H 192.168.0.1
$ smbget -R smb://192.168.0.1/bla
$ smbmap -u jsmith -p password1 -d workgroup -H 192.168.0.1
$ smbmap -u 'apadmin' -p 'asdf1234!' -d ACME -h 10.1.3.30 -x 'net group "Domain Admins" /domain' 
```

#### Download files
```
root@kali:~# smbmap -R Foldername -H //server/ -A filename -q
```
#### Mount a shared folder
```
root@kali:~# mount -t cifs //server/share /mnt/share
```
### Metasploit

![Screenshot from 2021-09-14 17-24-02](https://user-images.githubusercontent.com/90088533/134135359-ae438efd-0aa3-4f8d-8ddb-36bc3b02ba02.png)
```
Example

#use auxiliary/scanner/smb/pipe_auditor
#show options
#set RHOSTS ip
#set THREADS 11
#run
```
### rpcclient 
  Check Null Sessions
```
root@kali:~# rpcclient -U “ ” -N ip
	   -U “ “ - null session
	   -N - no password
```




