# SMB (Server Message Block) : Port 135, 445
	
The Server Message Block protocol (SMB protocol) is a client-server communication protocol used for sharing access to files, printers, serial ports and other resources on a network. It can also carry transaction protocols for interprocess communication.
SMB has been used primarily to connect Windows computers, although most other systems -- such as Linux and macOS -- also include client components for connecting to SMB resources.

#### Working: 

At a high-level, SMB communication is easy to understand. SMB clients connect to an SMB server using the SMB port to access SMB shares. Once they access the SMB shares, clients can do things such as collaborate on files without downloading them to their machines or print using a networked printer. 

### SMB server:
An SMB server is the network server — or cluster of servers — where SMB shares are stored. The SMB server grants or denies SMB clients access to the shared resources.

### SMB client:
An SMB client is the device that accesses resources on an SMB server. For example, within a corporate network, the user PCs that access a shared drive are SMB clients. 

### SMB Share:
An SMB share, also known as an SMB file share, is simply a shared resource on an SMB server. Often, an SMB share is a directory, but it can be any shared resource. For example, network printers are often shared using SMB. 

### SMB port:
By default, modern implementations of SMB use TCP port 445 as the SMB port. Older SMB implementations (pre-Windows 2000) used SMB port 139.


### SMB Versions
```
    CIFS: The old version of SMB, which was included in Microsoft Windows NT 4.0 in 1996.
    SMB 1.0 / SMB1: The version used in Windows 2000, Windows XP, Windows Server 2003 and Windows Server 2003 R2.
    SMB 2.0 / SMB2: This version used in Windows Vista and Windows Server 2008.
    SMB 2.1 / SMB2.1: This version used in Windows 7 and Windows Server 2008 R2.
    SMB 3.0 / SMB3: This version used in Windows 8 and Windows Server 2012.
    SMB 3.02 / SMB3: This version used in Windows 8.1 and Windows Server 2012 R2.
    SMB 3.1: This version used in Windows Server 2016 and Windows 10.
```
#### Enumeration Tools:

### Nmap:

```
root@kali:~# ls /usr/share/nmap/scripts | grep smb
		smb2-capabilities.nse
		smb2-security-mode.nse
		smb2-time.nse
		smb2-vuln-uptime.nse
		smb-brute.nse
		smb-double-pulsar-backdoor.nse
		smb-enum-domains.nse
		smb-enum-groups.nse
		smb-enum-processes.nse
		smb-enum-services.nse
		smb-enum-sessions.nse
		smb-enum-shares.nse
		smb-enum-users.nse
		smb-flood.nse
		smb-ls.nse
		smb-mbenum.nse
		smb-os-discovery.nse
		smb-print-text.nse
		smb-protocols.nse
		smb-psexec.nse
		smb-security-mode.nse
		smb-server-stats.nse
		smb-system-info.nse
		smb-vuln-conficker.nse
		smb-vuln-cve2009-3103.nse
		smb-vuln-cve-2017-7494.nse
		smb-vuln-ms06-025.nse
		smb-vuln-ms07-029.nse
		smb-vuln-ms08-067.nse
		smb-vuln-ms10-054.nse
		smb-vuln-ms10-061.nse
		smb-vuln-ms17-010.nse
		smb-vuln-regsvc-dos.nse
		smb-vuln-webexec.nse
		smb-webexec-exploit.nse
```
Command:
```
nmap --script <smb-scripts> [target-ip]
```

### enum4linux:
Enumerates Hostname, SMB shares Usernames, passwords.

The -S flag will give us information about the SMB shares on the machine:
```
root@kali:~#enum4linux -S 10.10.0.50

		Starting enum4linux v0.8.9 ( http://labs.portcullis.co.uk/application/enum4linux/ )

		 ==========================
		|    Target Information    |
		 ==========================
		Target ........... 10.10.0.50
		RID Range ........ 500-550,1000-1050
		Username ......... ''
		Password ......... ''
		Known Usernames .. administrator, guest, krbtgt, domain admins, root, bin, none

		 ==================================================
		|    Enumerating Workgroup/Domain on 10.10.0.50    |
		 ==================================================
		[+] Got domain/workgroup name: WORKGROUP

		 ===================================
		|    Session Check on 10.10.0.50    |
		 ===================================
		[+] Server 10.10.0.50 allows sessions using username '', password ''

		 =========================================
		|    Getting domain SID for 10.10.0.50    |
		 =========================================
		Domain Name: WORKGROUP
		Domain Sid: (NULL SID)
		[+] Can't determine if host is part of domain or part of a workgroup

		 =======================================
		|    Share Enumeration on 10.10.0.50    |
		 =======================================

		    Sharename       Type      Comment
		    ---------       ----      -------
		    print$          Disk      Printer Drivers
		    tmp             Disk      oh noes!
		    opt             Disk
		    IPC$            IPC       IPC Service (metasploitable server (Samba 3.0.20-Debian))
		    ADMIN$          IPC       IPC Service (metasploitable server (Samba 3.0.20-Debian))
		Reconnecting with SMB1 for workgroup listing.

		    Server               Comment
		    ---------            -------

		    Workgroup            Master
		    ---------            -------
		    WORKGROUP            METASPLOITABLE

		[+] Attempting to map shares on 10.10.0.50
		//10.10.0.50/print$ Mapping: DENIED, Listing: N/A
		//10.10.0.50/tmp    Mapping: OK, Listing: OK
		//10.10.0.50/opt    Mapping: DENIED, Listing: N/A
		//10.10.0.50/IPC$   [E] Can't understand response:
		NT_STATUS_NETWORK_ACCESS_DENIED listing \*
		//10.10.0.50/ADMIN$ Mapping: DENIED, Listing: N/A
```
Flag -p tell us whether we have access or not to a particular share.
```
root@kali:~# enum4linux -P 10.10.0.50

		Starting enum4linux v0.8.9 ( http://labs.portcullis.co.uk/application/enum4linux/ )

		 ==========================
		|    Target Information    |
		 ==========================
		Target ........... 10.10.0.50
		RID Range ........ 500-550,1000-1050
		Username ......... ''
		Password ......... ''
		Known Usernames .. administrator, guest, krbtgt, domain admins, root, bin, none

		 ==================================================
		|    Enumerating Workgroup/Domain on 10.10.0.50    |
		 ==================================================
		[+] Got domain/workgroup name: WORKGROUP

		 ===================================
		|    Session Check on 10.10.0.50    |
		 ===================================
		[+] Server 10.10.0.50 allows sessions using username '', password ''

		 =========================================
		|    Getting domain SID for 10.10.0.50    |
		 =========================================
		Domain Name: WORKGROUP
		Domain Sid: (NULL SID)
		[+] Can't determine if host is part of domain or part of a workgroup

		 ==================================================
		|    Password Policy Information for 10.10.0.50    |
		 ==================================================

		[+] Attaching to 10.10.0.50 using a NULL share

		[+] Trying protocol 445/SMB...

		[+] Found domain(s):

		    [+] METASPLOITABLE
		    [+] Builtin

		[+] Password Info for Domain: METASPLOITABLE

		    [+] Minimum password length: 5
		    [+] Password history length: None
		    [+] Maximum password age: Not Set
		    [+] Password Complexity Flags: 000000

		        [+] Domain Refuse Password Change: 0
		        [+] Domain Password Store Cleartext: 0
		        [+] Domain Password Lockout Admins: 0
		        [+] Domain Password No Clear Change: 0
		        [+] Domain Password No Anon Change: 0
		        [+] Domain Password Complex: 0

		    [+] Minimum password age: None
		    [+] Reset Account Lockout Counter: 30 minutes
		    [+] Locked Account Duration: 30 minutes
		    [+] Account Lockout Threshold: None
		    [+] Forced Log off Time: Not Set

		[+] Retieved partial password policy with rpcclient:

		Password Complexity: Disabled
		Minimum Password Length: 0
```
Flag -o to check the versions.
```
root@kali:~# enum4linux -o 10.10.0.50

		Starting enum4linux v0.8.9 ( http://labs.portcullis.co.uk/application/enum4linux/ )

		 ==========================
		|    Target Information    |
		 ==========================
		Target ........... 10.10.0.50
		RID Range ........ 500-550,1000-1050
		Username ......... ''
		Password ......... ''
		Known Usernames .. administrator, guest, krbtgt, domain admins, root, bin, none

		 ==================================================
		|    Enumerating Workgroup/Domain on 10.10.0.50    |
		 ==================================================
		[+] Got domain/workgroup name: WORKGROUP

		 ===================================
		|    Session Check on 10.10.0.50    |
		 ===================================
		[+] Server 10.10.0.50 allows sessions using username '', password ''

		 =========================================
		|    Getting domain SID for 10.10.0.50    |
		 =========================================
		Domain Name: WORKGROUP
		Domain Sid: (NULL SID)
		[+] Can't determine if host is part of domain or part of a workgroup

		 ====================================
		|    OS information on 10.10.0.50    |
		 ====================================
		Use of uninitialized value $os_info in concatenation (.) or string at ./enum4linux.pl line 464.
		[+] Got OS info for 10.10.0.50 from smbclient:
		[+] Got OS info for 10.10.0.50 from srvinfo:
		    METASPLOITABLE Wk Sv PrQ Unx NT SNT metasploitable server (Samba 3.0.20-Debian)
		    platform_id     :   500
		    os version      :   4.9
		    server type     :   0x9a03
```
We can quickly get all the SMB information we need in one scan — use the -a flag to run all simple enumeration.
```
root@kali:~# enum4linux -a 10.10.0.50

		Starting enum4linux v0.8.9 ( http://labs.portcullis.co.uk/application/enum4linux/ ) 

		 ==========================
		|    Target Information    |
		 ==========================
		Target ........... 10.10.0.50
		RID Range ........ 500-550,1000-1050
		Username ......... ''
		Password ......... ''
		Known Usernames .. administrator, guest, krbtgt, domain admins, root, bin, none

		 ==================================================
		|    Enumerating Workgroup/Domain on 10.10.0.50    |
		 ==================================================
		[+] Got domain/workgroup name: WORKGROUP

		 ==========================================
		|    Nbtstat Information for 10.10.0.50    |
		 ==========================================
		Looking up status of 10.10.0.50
		    METASPLOITABLE  <00> -         B <ACTIVE>  Workstation Service
		    METASPLOITABLE  <03> -         B <ACTIVE>  Messenger Service
		    METASPLOITABLE  <20> -         B <ACTIVE>  File Server Service
		    ..__MSBROWSE__. <01> - <GROUP> B <ACTIVE>  Master Browser
		    WORKGROUP       <00> - <GROUP> B <ACTIVE>  Domain/Workgroup Name
		    WORKGROUP       <1d> -         B <ACTIVE>  Master Browser
		    WORKGROUP       <1e> - <GROUP> B <ACTIVE>  Browser Service Elections

		    MAC Address = 00-00-00-00-00-00

		 ===================================
		|    Session Check on 10.10.0.50    |
		 ===================================
		[+] Server 10.10.0.50 allows sessions using username '', password ''

		...

		 ============================
		|    Groups on 10.10.0.50    |
		 ============================

		[+] Getting builtin groups:

		[+] Getting builtin group memberships:

		[+] Getting local groups:

		[+] Getting local group memberships:

		[+] Getting domain groups:

		[+] Getting domain group memberships:

		 =====================================================================
		|    Users on 10.10.0.50 via RID cycling (RIDS: 500-550,1000-1050)    |
		 =====================================================================
		[I] Found new SID: S-1-5-21-1042354039-2475377354-766472396
		[+] Enumerating users using SID S-1-5-21-1042354039-2475377354-766472396 and logon username '', password ''
		S-1-5-21-1042354039-2475377354-766472396-500 METASPLOITABLE\Administrator (Local User)
		S-1-5-21-1042354039-2475377354-766472396-501 METASPLOITABLE\nobody (Lo
			........................
```

### Smbclient:
We can get a list of shares on the target by using the -L flag followed by the IP address of the server.
```
		root@kali:~# smbclient -L //10.10.0.50/

		Enter WORKGROUP\root's password:
		Anonymous login successful

		    Sharename       Type      Comment
		    ---------       ----      -------
		    print$          Disk      Printer Drivers
		    tmp             Disk      oh noes!
		    opt             Disk
		    IPC$            IPC       IPC Service (metasploitable server (Samba 3.0.20-Debian))
		    ADMIN$          IPC       IPC Service (metasploitable server (Samba 3.0.20-Debian))
		Reconnecting with SMB1 for workgroup listing.
		Anonymous login successful

		    Server               Comment
		    ---------            -------

		    Workgroup            Master
		    ---------            -------
		    WORKGROUP            METASPLOITABLE
```

Use the -U flag to specify the username (in this case a blank string) and the -N flag to specify no password.
```
root@kali:~# smbclient -L //10.10.0.50/ -U '' -N

		    Sharename       Type      Comment
		    ---------       ----      -------
		    print$          Disk      Printer Drivers
		    tmp             Disk      oh noes!
		    opt             Disk
		    IPC$            IPC       IPC Service (metasploitable server (Samba 3.0.20-Debian))
		    ADMIN$          IPC       IPC Service (metasploitable server (Samba 3.0.20-Debian))
		Reconnecting with SMB1 for workgroup listing.

		    Server               Comment
		    ---------            -------

		    Workgroup            Master
		    ---------            -------
		    WORKGROUP            METASPLOITABLE
```
Connecting to SMB.
```
root@kali:~# smbclient //10.10.0.50/tmp
				
		Enter WORKGROUP\root's password:
		Anonymous login successful
		Try "help" to get a list of possible commands.
		smb: \> help
		?              allinfo        altname        archive        backup
		blocksize      cancel         case_sensitive cd             chmod
		chown          close          del            deltree        dir
		du             echo           exit           get            getfacl
		geteas         hardlink       help           history        iosize
		lcd            link           lock           lowercase      ls
		l              mask           md             mget           mkdir
		more           mput           newer          notify         open
		posix          posix_encrypt  posix_open     posix_mkdir    posix_rmdir
		posix_unlink   posix_whoami   print          prompt         put
		pwd            q              queue          quit           readlink
		rd             recurse        reget          rename         reput
		rm             rmdir          showacls       setea          setmode
		scopy          stat           symlink        tar            tarmode
		timeout        translate      unlock         volume         vuid
		wdel           logon          listconnect    showconnect    tcon
		tdis           tid            utimes         logoff         ..
		!
		smb: \> pwd
		Current directory is \\10.10.0.50\tmp\
		smb: \>
```
###  smbmap:
This tools help in finding samba share drives across an entire domain.
```
# smbmap -u [username] -p [password] -H [target-ip]
```
